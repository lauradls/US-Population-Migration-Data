# Results

```{r, warning = FALSE, results = 'hide', message = FALSE}
# install.packages("datasets")
# install.packages("ggplot2")
# install.packages("dplyr")
# install.packages("mi")
# install.packages("naniar")
# install.packages("vcdExtra")
#install.packages("ggalluvial")
library(datasets) 
library(ggplot2) 
library(dplyr) 
library(data.table)
library(tidyverse)
library(mi)
library(magrittr)
library(plyr)
library(naniar)
library(vcdExtra)
library(ggalluvial)
```

## Migration of Individuals

```{r, echo=FALSE, warning=FALSE}
df <- read.csv("migration_data/df_preprocessed.csv")

#Convert to groups/unordered factors
factors_unordered <- c("Status", "State", "State_name")

for (i in factors_unordered){
    df[, i] <- as.factor(df[, i])
}

##Convert age groups to an ordered factor
factors_ordered <- unique(df[,"Age"])

df[,"Age"] <- factor(df[,"Age"], ordered=TRUE, levels=c("under 26", "26 under 35", "35 under 45","45 under 55","55 under 65", "65 and over"))

df[,"GTI"] <- factor(df[,"GTI"], ordered=TRUE, levels=c("$1 under $10,000", "$10,000 under $25,000", "$25,000 under $50,000", "$50,000 under $75,000", "$75,000 under $100,000", "$100,000 under $200,000", "$200,000 or more"))

```

```{r, echo=FALSE, warning=FALSE}
percentages <- function(df){
  df$ind_perc <- (df$Individuals/sum(df$Individuals))
  return(df)
}
```

Migration flow within the United States is driven by several competing forces. Although it is all happening in the same country and it varies from State to State, it also affects Age groups and Income levels differently.

During the 2016-2020 period, we observe the majority of individuals staying within their county.

Based on the chart below, the **most transient group is composed of individuals making between `$1 to $10,000`** as they moved out, moved around, and moved into a different state. Our assumptions are that this could be due to having bigger needs to look for better employment opportunities and they might also have the flexibility to move around more if they do not have stable/long term contracts. On the other hand, **the most stationary group is individuals making `$200,000 or more` per year**. This can be tied to the fact that they might not need to change their primary residence, are comfortable where they live and if desired, they could have the discretionary income to spend time at their second home (i.e. during COVID-19). 

```{r, echo=FALSE, warning=FALSE}
#Migration flow 2015-2020 per GTI
df_sum <- ddply(df[,c("GTI", "Status", "Individuals")], .(GTI), percentages)

df_sum <- as.data.table(df_sum)[, sum(ind_perc), by = .(GTI, Status)]


ggplot(df_sum, aes(fill=fct_rev(Status), x=GTI,
                         y=V1)) +
  geom_col(position = "fill", alpha = .75) +
  ylab("Migration Status") +
  ggtitle('Migration Status per Gross Total Income 2015-2020') +
  xlab('Gross Total Income') +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_classic() +
  theme(legend.position = "top", legend.title = element_blank())
```
Comparing the type of migration across age groups reveals insights that are more in line with our previous assumptions. Younger people tend to migrate more than older adults. There seems to be a negative relationship between age and moving. 

```{r, echo=FALSE, warning=FALSE}
#Migration flow 2015-2020 per GTI
df_sum <- ddply(df[,c("Individuals", "Status","Age")], .(Age), percentages)

df_sum <- as.data.table(df_sum)[, sum(ind_perc), by = .(Age, Status)]

ggplot(df_sum, aes(fill=Status, x=Age,
                         y=V1)) +
  geom_col(position = "fill", alpha = .75) +
  ylab('Age Group') +
  ggtitle('Migration Status by Age 2015-2020') +
  xlab("Migration Status") +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_classic() +
  theme(legend.position = "top", legend.title = element_blank())
```



## Number of Tax Returns


```{r, echo=FALSE, warning=FALSE}
mig_data <- read.csv("migration_data/df.csv")
mig_data <- mig_data %>% select(-X)

# Combine 
mig_grouped <- as.data.table(mig_data)[, sum(Returns), by = .(Age, Status, State_name)]

# assigning the column name to a new name
colnames(mig_grouped)[4] <- "Total_returns"
colnames(mig_grouped)[3] <- "State_name"

top_total_states <- c("California", "Texas", "Florida", "New York", "Pennsylvania", "Illinois")

# Filter plotting data
status_vec <- c("Inflow", "Outflow", "Same State")

mig_grouped <- mig_grouped %>% 
  filter(Status %in% status_vec) %>%
  filter(State_name %in% top_total_states)


ggplot(mig_grouped, aes(x = reorder(State_name, desc(Total_returns)), y = Total_returns, fill = Status)) +
  geom_bar(position = "dodge", stat = "identity") +
  facet_wrap(~factor(Age, levels=c('under 26', '26 under 35', '35 under 45', '45 under 55', '55 under 65', '65 and over'))) +
  # formatting
  ggtitle("State & age wise inflow and outflow comparsion") +
  labs(y = "Number of Returns", x = "States") +
  theme(plot.title = element_text(face = "bold")) +
  theme(plot.subtitle = element_text(face = "bold", color = "grey35")) +
  theme(plot.caption = element_text(color = "grey68")) + 
  theme(axis.text = element_text(size = 4))

```

```{r, echo=FALSE, warning=FALSE}
mig_data <- read.csv("migration_data/df.csv")
mig_data <- mig_data %>% select(-X)

colnames(mig_data)[9] <- "Gross_total_income"

# Combine
mig_grouped <- as.data.table(mig_data)[, sum(Returns), by = .(Gross_total_income, Status, State_name)]


# assigning the column name to a new name
colnames(mig_grouped)[4] <- "Total_returns"
colnames(mig_grouped)[3] <- "State_name"

top_total_states <- c("California", "Texas", "Florida", "New York", "Pennsylvania", "Illinois")

# Filter plotting data
status_vec <- c("Inflow", "Outflow", "Same State")

mig_grouped <- mig_grouped %>% 
  filter(Status %in% status_vec) %>%
  filter(State_name %in% top_total_states)


ggplot(mig_grouped, aes(x = reorder(State_name, desc(Total_returns)), y = Total_returns, fill = Status)) +
  geom_bar(position = "dodge", stat = "identity") +
  facet_wrap(~factor(Gross_total_income,  levels=c('$1 under $10,000', '$10,000 under $25,000', '$25,000 under $50,000', '$50,000 under $75,000', '$75,000 under $100,000', '$100,000 under $200,000', '$200,000 or more'))) +
  # formatting
  ggtitle("State & Gross Income wise inflow and outflow comparsion") +
  labs(y = "Number of Returns", x = "States") +
  theme(plot.title = element_text(face = "bold")) +
  theme(plot.subtitle = element_text(face = "bold", color = "grey35")) +
  theme(plot.caption = element_text(color = "grey68")) + 
  theme(axis.text = element_text(size = 4))

```



## Temporal Analysis | Migration by Year


```{r, echo=FALSE, warning=FALSE}
#We will now read the file
mig_data <- read.csv("migration_data/df.csv")
mig_data <- mig_data %>% select(-X)

colnames(mig_data)[9] <- "Gross_total_income"

# Combine
mig_grouped <- as.data.table(mig_data)[, sum(Returns), by = .(Year, Status, State_name)]

# assigning the column name to a new name
colnames(mig_grouped)[4] <- "Total_returns"
colnames(mig_grouped)[3] <- "State_name"

top_total_states <- c("California", "Texas", "Florida", "New York", "Pennsylvania", "Illinois")

# Filter plotting data
status_vec <- c("Inflow", "Outflow", "Same State")

mig_grouped <- mig_grouped %>% 
  filter(Status %in% status_vec) %>%
  filter(State_name %in% top_total_states)


ggplot(mig_grouped, aes(x = reorder(State_name, desc(Total_returns)), y = Total_returns, fill = Status)) +
  geom_bar(position = "dodge", stat = "identity") +
  facet_wrap(~(Year)) +
  # formatting
  ggtitle("State & Year wise inflow and outflow comparsion") +
  labs(y = "Number of Returns", x = "States") +
  theme(plot.title = element_text(face = "bold")) +
  theme(plot.subtitle = element_text(face = "bold", color = "grey35")) +
  theme(plot.caption = element_text(color = "grey68"))+ 
  theme(axis.text = element_text(size = 4))


```

```{r, echo=FALSE, warning=FALSE}
#We will now read the file
mig_data <- read.csv("migration_data/df.csv")

colnames(mig_data)[9] <- "Gross_total_income"

# Combine
mig_grouped <- as.data.table(mig_data)[, sum(Returns), by = .(Year, Status, State_name)]

# assigning the second column name to a new name
colnames(mig_grouped)[4] <- "Total_returns"
colnames(mig_grouped)[3] <- "State_name"

top_total_states <- c("California", "Texas", "Florida", "New York", "Pennsylvania", "Illinois")

# Filter plotting data
status_vec <- c("Inflow", "Outflow", "Same State")

mig_grouped <- mig_grouped %>% 
  filter(Status %in% status_vec) %>%
  filter(State_name %in% top_total_states) %>%
  mutate(State_name = forcats::fct_reorder2(State_name, Year, Total_returns))


ggplot(mig_grouped, aes(Year, Total_returns, color = State_name)) + geom_line() +
  ggtitle("Total Returns from 2016 to 2020") +
  facet_wrap(~factor(Status)) +
  labs (x = "Year", y = "Total Returns") +
  theme_grey(16) +
  theme(legend.title = element_blank())+ 
  theme(axis.text = element_text(size = 5))



```


```{r, echo=FALSE, warning=FALSE}
#We will now read the file
mig_data <- read.csv("df.csv")

colnames(mig_data)[9] <- "Gross_total_income"

# Combine
mig_grouped <- as.data.table(mig_data)[, sum(Returns), by = .(Year, Status, State_name)]

# assigning the second column name to a new name
colnames(mig_grouped)[4] <- "Total_returns"
colnames(mig_grouped)[3] <- "State_name"

top_total_states <- c("California", "Texas", "Florida", "New York", "Pennsylvania", "Illinois")

# Filter plotting data
status_vec <- c("Non-migrant" )

mig_grouped <- mig_grouped %>% 
  filter(Status %in% status_vec) %>%
  filter(State_name %in% top_total_states) %>%
  mutate(State_name = forcats::fct_reorder2(State_name, Year, Total_returns))


ggplot(mig_grouped, aes(Year, Total_returns, color = State_name)) + geom_line() +
  ggtitle("Total Returns from 2016 to 2020") +
  facet_wrap(~factor(Status)) +
  labs (x = "Year", y = "Total Returns") +
  theme_grey(16) +
  theme(legend.title = element_blank())


```



<!-- #We will now read the file -->
<!-- mig_data <- read.csv("df.csv") -->

<!-- # create a theme for dot plots, which can be reused -->
<!-- theme_dotplot <- theme_bw(14) + -->
<!--   theme(axis.text.y = element_text(size = rel(.75)), -->
<!--         axis.ticks.y = element_blank(), -->
<!--         axis.title.x = element_text(size = rel(.75)), -->
<!--         panel.grid.major.x = element_blank(), -->
<!--         panel.grid.major.y = element_line(size = 0.5), -->
<!--         panel.grid.minor.x = element_blank()) -->

<!-- colnames(mig_data)[9] <- "Gross_total_income" -->

<!-- # Combine  -->
<!-- mig_grouped <- as.data.table(mig_data)[, sum(Returns), by = .(Year, Status, State_name)] -->

<!-- # assigning the second column name to a new name -->
<!-- colnames(mig_grouped)[4] <- "Total_returns" -->
<!-- colnames(mig_grouped)[3] <- "State_name" -->


<!-- # Filter plotting data -->
<!-- status_vec <- c("Inflow", "Outflow", "Same State") -->

<!-- mig_grouped <- mig_grouped %>%  -->
<!--   filter(Status %in% status_vec) %>% -->
<!--   filter(State_name != "Total US")  -->

<!-- ggplot(mig_grouped, -->
<!--        aes(Total_returns, fct_reorder2(State_name, Status, Total_returns, .desc = FALSE), -->
<!--            color = Status)) + -->
<!--   geom_point() + ggtitle("total returns for top 10 states facet by year") + ylab("") + -->
<!--   theme_dotplot + -->
<!--   facet_wrap(~factor(Year)) -->



```{r, echo=FALSE, warning=FALSE}
#We will now read the file
mig_data <- read.csv("df.csv")

# create a theme for dot plots, which can be reused
theme_dotplot <- theme_bw(14) +
  theme(axis.text.y = element_text(size = rel(.75)),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = rel(.75)),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(size = 0.5),
        panel.grid.minor.x = element_blank())

colnames(mig_data)[9] <- "Gross_total_income"

# Combine 
mig_grouped <- as.data.table(mig_data)[, sum(Returns), by = .(Status, State_name)]

# assigning the second column name to a new name
colnames(mig_grouped)[3] <- "Total_returns"
colnames(mig_grouped)[2] <- "State_name"


# Filter plotting data
status_vec <- c("Inflow", "Outflow", "Same State")

mig_grouped <- mig_grouped %>% 
  filter(Status %in% status_vec) %>%
  filter(State_name != "Total US")
ggplot(mig_grouped,
       aes(Total_returns, fct_reorder2(State_name, Status, Total_returns, .desc = FALSE),
           color = Status)) +
  geom_point() + ggtitle("total returns for top 10 states facet by year") + ylab("") +
  theme_dotplot 

```



```{r, echo=FALSE, warning=FALSE}
#We will now read the file
mig_data <- read.csv("df.csv")

# create a theme for dot plots, which can be reused
theme_dotplot <- theme_bw(14) +
  theme(axis.text.y = element_text(size = rel(.75)),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = rel(.75)),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(size = 0.5),
        panel.grid.minor.x = element_blank())

colnames(mig_data)[9] <- "Gross_total_income"

# Combine 
mig_grouped <- as.data.table(mig_data)[, sum(Returns), by = .(Year, Status, State_name)]

# assigning the second column name to a new name
colnames(mig_grouped)[4] <- "Total_returns"
colnames(mig_grouped)[3] <- "State_name"

top_total_states <- c("California", "Texas", "Florida", "New York", "Georgia", "Virgina", "Ohio", "North Carolina", "Michigan", "Illinois")

# Filter plotting data
status_vec <- c("Inflow", "Outflow", "Same State")

mig_grouped <- mig_grouped %>% 
  filter(Status %in% status_vec) %>%
  filter(State_name != "Total US") %>%
  filter(State_name %in% top_total_states)

ggplot(mig_grouped,
       aes(Total_returns, fct_reorder2(State_name, Status, Total_returns, .desc = FALSE),
           color = Status)) +
  geom_point() + ggtitle("total returns for top 10 states facet by year") + ylab("") +
  theme_dotplot +
  facet_wrap(~factor(Year))

```



```{r, echo=FALSE, warning=FALSE}

```
